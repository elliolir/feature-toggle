service:
  name: feature-toggle-experiments

plugins:
  - serverless-webpack
  - serverless-offline
  - serverless-dotenv-plugin
  - serverless-plugin-aws-alerts
  - serverless-pseudo-parameters

custom:
  webpack:
    webpackConfig: ./webpack.config.js
    includeModules: true
  alerts:
    dashboards: true
    nameTemplate: $[functionName]-$[metricName]-Alarm
    prefixTemplate: $[stackName]
    topics:
      alarm:
        topic: arn:aws:sns:${self:provider.region}:#{AWS::AccountId}:${self:service}-feature-errors-alarm
        notifications:
          - protocol: lambda
            endpoint: arn:aws:lambda:${self:provider.region}:#{AWS::AccountId}:function:${self:service}-${self:provider.stage}-feature-killer
    alarms:
      - functionErrors

provider:
  name: aws
  runtime: nodejs12.x
  apiGateway:
    minimumCompressionSize: 1024 # Enable gzip compression for responses > 1 KB
  environment:
    AWS_NODEJS_CONNECTION_REUSE_ENABLED: 1
    SDK_KEY: ${env:SDK_KEY}
    API_KEY: ${env:API_KEY}
    FEATURE_NAME: ${env:FEATURE_NAME}

functions:
  main:
    handler: functions/index.handler
    events:
      - http:
          method: get
          path: "/"
    alarms:
      - functionErrors
  feature-killer:
    handler: functions/featureKiller/index.handler
    events:
      - http:
          method: patch
          path: "/feature"
      - sns:
          arn: !Ref FeatureErrorsAlarm
          topicName: ${self:service}-feature-errors-alarm

resources:
  Resources:
    FeatureErrorsAlarm:
      Type: AWS::SNS::Topic
      Properties:
        TopicName: ${self:service}-feature-errors-alarm
